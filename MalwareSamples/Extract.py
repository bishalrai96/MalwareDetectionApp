import os
from subprocess import check_output
import subprocess
import xml.etree.ElementTree as ET
import csv

FolderNames = []
permissions = []

Malware_Benign = r"\Malware"

def Init():
	f = open ("data.csv", "w")
	f.write ("Type" + ",")

	with open(r"..\MLModelDev\permissionList.txt", "r") as file:
		print ("opened")
		for lines in file:
			lines = lines[:-1]
			permissions.append(lines);
	for lines in permissions:
		f.write(lines + ',')

	f.write("\n")
	f.seek(f.tell() - 1,  os.SEEK_SET)
	f.close()
	

	print (permissions)
	Extract("M")
	Extract("B")


def Extract(Type) :
	
	if Type == "M":
		Malware_Benign = r"Malware"
		os.chdir(Malware_Benign)
	else :
		Malware_Benign = "..\\Benign"
		os.chdir(Malware_Benign)

	
	for filename in os.listdir(os.curdir):
		print ("filename " + Malware_Benign + filename)
		
		call = 'apktool d '+ filename
		if '.apk' in filename:
			filename = filename[:-4] 
			print ("extracting " + filename + " .......")
			FolderNames.append(filename)
			print("foldername " + filename)
			print ("Call " + call)			
			try:
				subprocess.call (call, shell=True, stderr=subprocess.STDOUT)
			except:
				print(filename + " already Exist Moving to different one")
			
	print ("Extracted Files, writing to data.csv now")
	Parser(Type)


def Parser(_type) :
	f = open ("..\data.csv", "a")
	
	for filename in FolderNames:
		dir_path = os.path.dirname(os.path.realpath(filename))
		print(dir_path)
		f.write(_type + ",")
		print ("In folder " + filename)
		tree = ET.parse(filename + '\AndroidManifest.xml')
		root = tree.getroot()
		
		permissionList = []

		userPermission = root.findall("uses-permission")
		userFeature    = root.findall("uses-feature")
			
		
		print("In Parser...............")
		for permission in userPermission:
			for att in permission.attrib:
				permissionList.append(permission.attrib[att])

		for per in permissions:
			if per in permissionList:
				f.write("1" + ",")
			else :
				f.write("0,")

		f.write("\n")
		print ("next xml file ...................................")
		print ("\n")
	f.close()
	
	del FolderNames[:]
	for filename in FolderNames:
		print("***********\n")
		print (filename + "\n")


Init()
