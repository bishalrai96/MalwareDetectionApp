import os
from subprocess import check_output
import subprocess
import xml.etree.ElementTree as ET

FolderNames = []
nameSpace = "http://schemas.android.com/apk/res/android"

def Extract() :
	for filename in os.listdir(r'C:\Users\Bishal\Desktop\Graduate\DissertationApp\MalwareSamples'):
		call = 'apktool d '+ filename
		if '.apk' in filename:
			filename = filename[:-4] 
			print ("extracting " + filename + " .......")

			if not os.path.isfile("data.csv"):
				FolderNames.append(filename)
				print ("data.csv does not exsist")
			elif not os.path.isdir(filename):
				print (filename + "does not EXSIST")
				FolderNames.append(filename)
			
			try:
				subprocess.check_output (call, shell=True, stderr=subprocess.STDOUT)
				
			except:
				print(filename + " already Exist Moving to different one")
	print ("Extracted Files, writing to files now")
	Parser()


def Parser() :
	
	for filename in FolderNames:
		tree = ET.parse(filename + '\AndroidManifest.xml')
		root = tree.getroot()
		
		permissionList = []

		userPermission = root.findall("uses-permission")
		userFeature    = root.findall("uses-feature")
		

		for permission in userPermission:
			for att in permission.attrib:
				permissionList.append(permission.attrib[att])

		if len(userFeature) != 0:
			for feature in userFeature:
				for att in feature.attrib:
					permissionList.append(feature.attrib[att])
					print (feature.attrib[att])
		
		f = open ("data.csv", "a")
		
		for x in permissionList:
				f.write(x + ',')	

		f.write("End")
		f.write('\n')
		f.close()
			

	
Extract()

