import os
from subprocess import check_output
import subprocess
import xml.etree.ElementTree as ET
import csv

FolderNames = []
permissions = []

def Extract() :

	_Malware = "M"
	_Beign   = "B"

	with open(r"C:\Users\ryeki\Desktop\Graduate\Dissertation\MalwareDetectionApp\MLModelDev\permissionList.txt", "r") as file:
		print ("opened")
		for lines in file:
			lines = lines[:-1]
			permissions.append(lines);

	print (permissions)
	
	f = open ("data.csv", "w")
	f.write ("Type" + ",")
	
	for lines in permissions:
		f.write(lines + ',')

	f.write("\n")
	f.seek(f.tell() - 1,  os.SEEK_SET)
	f.close()
	
	for filename in os.listdir(os.curdir):
		print ("filename " + filename)
		call = 'apktool d '+ filename
		if '.apk' in filename:
			filename = filename[:-4] 
			print ("extracting " + filename + " .......")
			FolderNames.append(filename)
			print("foldername " + filename)			
			try:
				subprocess.check_output (call, shell=True, stderr=subprocess.STDOUT)
			except:
				print(filename + " already Exist Moving to different one")
			
	print ("Extracted Files, writing to data.csv now")
	Parser(_Malware)


def Parser(_type) :
	f = open ("data.csv", "a")
	
	for filename in FolderNames:
		f.write(_type + ",")
		print ("In folder " + filename)
		tree = ET.parse(filename + '\AndroidManifest.xml')
		root = tree.getroot()
		
		permissionList = []

		userPermission = root.findall("uses-permission")
		userFeature    = root.findall("uses-feature")
			
		
		print("In Parser...............")
		for permission in userPermission:
			for att in permission.attrib:
				permissionList.append(permission.attrib[att])

		for per in permissions:
			if per in permissionList:
				f.write("1" + ",")
			else :
				f.write("0,")

		f.write("\n")
		print ("next xml file ...................................")
		print ("\n")
	f.close()

Extract()
