import os
from subprocess import check_output
import subprocess
import xml.etree.ElementTree as ET

FolderNames = []

def Extract() :
	for filename in os.listdir(os.curdir):
		call = 'apktool d '+ filename
		if '.apk' in filename:
			filename = filename[:-4] 
			print ("extracting " + filename + " .......")

			if not os.path.isfile("data.csv"):
				FolderNames.append(filename)
			elif not os.path.isdir(filename):
				FolderNames.append(filename)
			
			try:
				subprocess.check_output (call, shell=True, stderr=subprocess.STDOUT)
			except:
				print(filename + " already Exist Moving to different one")
	print ("Extracted Files, writing to data.csv now")
	Parser()


def Parser() :
	
	for filename in FolderNames:
		tree = ET.parse(filename + '\AndroidManifest.xml')
		root = tree.getroot()
		
		permissionList = []

		userPermission = root.findall("uses-permission")
		userFeature    = root.findall("uses-feature")
		

		for permission in userPermission:
			for att in permission.attrib:
				permissionList.append(permission.attrib[att])

		if len(userFeature) != 0:
			for feature in userFeature:
				for att in feature.attrib:
					permissionList.append(feature.attrib[att])
		
		f = open ("data.csv", "a")
		
		for x in permissionList:
				f.write(x + ',')	

		f.write("End")
		f.write('\n')
		f.close()
			

	
Extract()

